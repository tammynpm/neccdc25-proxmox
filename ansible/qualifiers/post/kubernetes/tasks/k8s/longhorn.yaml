---
# https://longhorn.io
# https://artifacthub.io/packages/helm/longhorn/longhorn
- name: Add Longhorn Helm repository #tammy 
  become: true
  become_user: ubuntu
  kubernetes.core.helm_repository:
    name: longhorn
    repo_url: https://charts.longhorn.io
    state: present

- name: Ensure Longhorn data path exists
  become: true
  ansible.builtin.file:
    path: /mount/longhorn
    state: directory
    owner: root
    group: root
    mode: "0755"
  tags: [services, longhorn]

- name: Deploy Longhorn
  become: true
  become_user: ubuntu
  ansible.builtin.command: >
    helm upgrade --install longhorn longhorn/longhorn
    --version 1.7.2
    --namespace infrastructure
    --create-namespace
    --set preUpgradeChecker.jobEnabled=false
    --set postUpgradeChecker.jobEnabled=false
    --set ingress.enabled=false
    --set defaultSettings.defaultDataPath=/mount/longhorn
    --set longhornUI.replicas=1
    --set metrics.serviceMonitor.enabled=true
    --set metrics.serviceMonitor.additionalLabels.release=prometheus
  register: longhorn_deploy
  retries: 3
  delay: 30
  until: longhorn_deploy.rc == 0
  changed_when: "'Release \"longhorn\" has been upgraded' in longhorn_deploy.stdout or 'has been installed' in longhorn_deploy.stdout"
  tags:
    - services
    - longhorn

# - name: Wait for Longhorn pods become ready
#   become: true
#   become_user: ubuntu
#   ansible.builtin.shell:
#     cmd: "kubectl wait --namespace=infrastructure --for=condition=Ready pods --selector app.kubernetes.io/instance=longhorn --timeout=180s"
#   tags:
#     - service
#     - longhorn

- name: Wait for Longhorn manager DaemonSet rollout
  become: true
  become_user: ubuntu
  ansible.builtin.command: >
    kubectl -n infrastructure rollout status daemonset/longhorn-manager --timeout=600s
  tags:
    - services
    - longhorn

- name: Wait for Longhorn driver deployer rollout
  become: true
  become_user: ubuntu
  ansible.builtin.command: >
    kubectl -n infrastructure rollout status deployment/longhorn-driver-deployer --timeout=600s
  tags:
    - services
    - longhorn

- name: Create Longhorn http route
  become: true
  become_user: ubuntu
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: gateway.networking.k8s.io/v1
      kind: HTTPRoute
      metadata:
        name: longhorn-http
        namespace: infrastructure
      spec:
        parentRefs:
          - name: traefik
            namespace: infrastructure
            sectionName: http
        hostnames:
          - "longhorn.placebo-pharma.com"
        rules:
          - matches:
              - path:
                  type: PathPrefix
                  value: /
            backendRefs:
              - name: longhorn-frontend
                namespace: infrastructure
                port: 80
  tags:
    - services
    - longhorn

- name: Create Longhorn https route
  become: true
  become_user: ubuntu
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: gateway.networking.k8s.io/v1
      kind: HTTPRoute
      metadata:
        name: longhorn-https
        namespace: infrastructure
      spec:
        parentRefs:
          - name: traefik
            namespace: infrastructure
            sectionName: https
        hostnames:
          - "longhorn.placebo-pharma.com"
        rules:
          - matches:
              - path:
                  type: PathPrefix
                  value: /
            backendRefs:
              - name: longhorn-frontend
                namespace: infrastructure
                port: 80
  tags:
    - services
    - longhorn
