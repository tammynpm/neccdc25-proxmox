---
- name: Install packages required for XAMPP installer
  ansible.builtin.apt:
    name:
      - wget
      - libx11-6
      - libc6
      - net-tools
    state: present
    update_cache: true
  tags:
    - xampp

- name: Stop and disable system Apache if present (avoid port 80 conflict)
  ansible.builtin.service:
    name: apache2
    state: stopped
    enabled: false
  ignore_errors: true
  tags:
    - xampp

- name: Stop and disable system MariaDB/MySQL if present (avoid port 3306 conflict)
  ansible.builtin.service:
    name: "{{ item }}"
    state: stopped
    enabled: false
  loop:
    - mariadb
    - mysql
  ignore_errors: true
  tags:
    - xampp

- name: Create temp directory for XAMPP installer
  ansible.builtin.file:
    path: /tmp/xampp_install
    state: directory
    mode: "0755"
  tags:
    - xampp

- name: Download XAMPP installer
  ansible.builtin.get_url:
    url: "{{ xampp_installer_url }}"
    dest: "/tmp/xampp_install/xampp-installer.run"
    mode: "0755"
  register: xampp_download
  tags:
    - xampp

- name: Run XAMPP installer (unattended)
  ansible.builtin.command:
    cmd: "/tmp/xampp_install/xampp-installer.run --mode unattended --launchapps 0"
    creates: "{{ xampp_root }}/lampp"
  when: xampp_download is changed or not ansible_check_mode
  tags:
    - xampp

- name: Ensure XAMPP is installed (idempotent check)
  ansible.builtin.stat:
    path: "{{ xampp_root }}/lampp"
  register: xampp_installed
  tags:
    - xampp

- name: Start XAMPP (Apache + MySQL)
  ansible.builtin.command:
    cmd: "{{ xampp_root }}/lampp start"
  when: xampp_installed.stat.exists | default(false)
  changed_when: true
  tags:
    - xampp

- name: Remove XAMPP installer temp files
  ansible.builtin.file:
    path: /tmp/xampp_install
    state: absent
  tags:
    - xampp
